<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autentica√ß√£o Externa</title>
    <script src="https://unpkg.com/thirdweb@5"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .auth-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            margin: 20px 0;
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
        }

        .status-loading {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-success {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status-error {
            background: #ffebee;
            color: #d32f2f;
        }

        h1 {
            margin: 0 0 10px;
            color: #333;
            font-size: 24px;
        }

        p {
            color: #666;
            margin: 0;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }

        .btn:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="loader"></div>
        <h1>Autenticando...</h1>
        <div id="status" class="status status-loading">
            <p>Conectando com sua carteira...</p>
        </div>
        <button id="closeBtn" class="btn" style="display: none;" onclick="window.close()">Fechar</button>
    </div>

    <script>
        console.log('üåê [AUTH EXTERNAL] Starting external authentication...');

        const urlParams = new URLSearchParams(window.location.search);
        const strategy = urlParams.get('strategy') || 'google';

        async function authenticate() {
            const statusEl = document.getElementById('status');
            const closeBtn = document.getElementById('closeBtn');

            try {
                // Get client ID
                const clientId = window.THIRDWEB_CLIENT_ID;
                if (!clientId) {
                    throw new Error('THIRDWEB_CLIENT_ID n√£o configurado');
                }

                // Create Thirdweb client
                const client = thirdweb.createThirdwebClient({ clientId });
                console.log('‚úÖ [AUTH EXTERNAL] Client created');

                // Create in-app wallet
                const wallet = thirdweb.inAppWallet();
                console.log(`üîó [AUTH EXTERNAL] Connecting with ${strategy}...`);

                statusEl.innerHTML = `<p>Autenticando com ${strategy}...</p>`;

                // Connect with redirect
                const redirectUrl = `${window.location.origin}/auth/callback`;
                const account = await wallet.connect({
                    client: client,
                    strategy: strategy,
                    redirectUrl: redirectUrl
                });

                if (!account) {
                    throw new Error('Falha ao conectar carteira');
                }

                console.log('‚úÖ [AUTH EXTERNAL] Wallet connected:', account.address);
                statusEl.className = 'status status-loading';
                statusEl.innerHTML = '<p>Autenticando com backend...</p>';

                // Get auth API base
                const authApiBase = window.location.origin.replace(/:\d+/, ':3001');

                // 1. Get login payload from backend
                const loginResponse = await fetch(`${authApiBase}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: account.address })
                });

                if (!loginResponse.ok) {
                    throw new Error('Falha ao obter payload de login');
                }

                const { payload } = await loginResponse.json();
                console.log('üìù [AUTH EXTERNAL] Login payload received');

                // 2. Sign payload
                let signature;
                try {
                    if (thirdweb.signLoginPayload) {
                        const signResult = await thirdweb.signLoginPayload({
                            account: account,
                            payload: payload
                        });
                        signature = typeof signResult === 'string' ? signResult : signResult.signature;
                    } else {
                        const messageToSign = JSON.stringify(payload);
                        signature = await wallet.signMessage({ message: messageToSign });
                    }
                } catch (error) {
                    console.error('‚ùå [AUTH EXTERNAL] Signing failed:', error);
                    throw new Error('Falha ao assinar payload');
                }

                console.log('‚úçÔ∏è [AUTH EXTERNAL] Payload signed');

                // 3. Verify signature with backend
                const verifyResponse = await fetch(`${authApiBase}/auth/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payload, signature })
                });

                if (!verifyResponse.ok) {
                    throw new Error('Falha na verifica√ß√£o de assinatura');
                }

                const { token } = await verifyResponse.json();
                console.log('‚úÖ [AUTH EXTERNAL] Authentication successful');

                // 4. Send to gateway backend
                const gatewayResponse = await fetch('/auth/telegram/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: account.address,
                        sessionKeyAddress: account.address,
                        loginPayload: payload,
                        signature: signature,
                        token: token,
                        telegram_user_id: urlParams.get('telegram_user_id') || 'unknown'
                    })
                });

                if (!gatewayResponse.ok) {
                    throw new Error('Falha ao registrar no gateway');
                }

                const result = await gatewayResponse.json();
                console.log('‚úÖ [AUTH EXTERNAL] Gateway registration successful:', result);

                // Show success
                statusEl.className = 'status status-success';
                statusEl.innerHTML = '<p>‚úÖ Autentica√ß√£o conclu√≠da! Voc√™ pode fechar esta janela.</p>';
                closeBtn.style.display = 'block';

                // Auto-close after 3 seconds
                setTimeout(() => {
                    window.close();
                }, 3000);

            } catch (error) {
                console.error('‚ùå [AUTH EXTERNAL] Authentication failed:', error);
                statusEl.className = 'status status-error';
                statusEl.innerHTML = `<p>‚ùå Erro: ${error.message}</p>`;
                closeBtn.style.display = 'block';
            }
        }

        // Start authentication when page loads
        window.addEventListener('load', authenticate);
    </script>
</body>
</html>
